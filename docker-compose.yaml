version: "3.6"

services:
  database:
    image: "websublime/postgres"
    container_name: "database"
    ports:
      - ${POSTGRES_PORT}:5432
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
    volumes:
      - ${DATA_PATH}/database:/var/lib/postgresql/data
      - ${PWD}/database:/docker-entrypoint-initdb.d/

  auth:
    image: "websublime/gotrue"
    container_name: "auth"
    ports:
      - ${GOTRUE_PORT}:${GOTRUE_PORT}
    environment:
      - GOTRUE_API_HOST=${GOTRUE_API_HOST}
      - DATABASE_URL=${GOTRUE_DATABASE_URL}
      - GOTRUE_DB_DRIVER=${GOTRUE_DB_DRIVER}
      - GOTRUE_DB_NAMESPACE=${GOTRUE_DB_NAMESPACE}
      - GOTRUE_DISABLE_SIGNUP=${GOTRUE_DISABLE_SIGNUP}
      - GOTRUE_JWT_ADMIN_GROUP_NAME=${GOTRUE_JWT_ADMIN_GROUP_NAME}
      - GOTRUE_JWT_AUD=${GOTRUE_JWT_AUD}
      - GOTRUE_JWT_DEFAULT_GROUP_NAME=${GOTRUE_JWT_DEFAULT_GROUP_NAME}
      - GOTRUE_JWT_EXP=${GOTRUE_JWT_EXP}
      - GOTRUE_JWT_SECRET=${GOTRUE_JWT_SECRET}
      - GOTRUE_LOG_LEVEL=${GOTRUE_LOG_LEVEL}
      - GOTRUE_MAILER_AUTOCONFIRM=${GOTRUE_MAILER_AUTOCONFIRM}
      - GOTRUE_MAILER_SUBJECTS_CONFIRMATION=${GOTRUE_MAILER_SUBJECTS_CONFIRMATION}
      - GOTRUE_MAILER_SUBJECTS_EMAIL_CHANGE=${GOTRUE_MAILER_SUBJECTS_EMAIL_CHANGE}
      - GOTRUE_MAILER_SUBJECTS_INVITE=${GOTRUE_MAILER_SUBJECTS_INVITE}
      - GOTRUE_MAILER_SUBJECTS_RECOVERY=${GOTRUE_MAILER_SUBJECTS_RECOVERY}
      - GOTRUE_MAILER_URLPATHS_CONFIRMATION=${GOTRUE_MAILER_URLPATHS_CONFIRMATION}
      - GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE=${GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE}
      - GOTRUE_MAILER_URLPATHS_INVITE=${GOTRUE_MAILER_URLPATHS_INVITE}
      - GOTRUE_MAILER_URLPATHS_RECOVERY=${GOTRUE_MAILER_URLPATHS_RECOVERY}
      - GOTRUE_OPERATOR_TOKEN=${GOTRUE_OPERATOR_TOKEN}
      - PORT=${GOTRUE_PORT}
      - GOTRUE_SITE_URL=${GOTRUE_SITE_URL}
      - GOTRUE_SMTP_ADMIN_EMAIL=${GOTRUE_SMTP_ADMIN_EMAIL}
      - GOTRUE_SMTP_HOST=${GOTRUE_SMTP_HOST}
      - GOTRUE_SMTP_PASS=${GOTRUE_SMTP_PASS}
      - GOTRUE_SMTP_PORT=${GOTRUE_SMTP_PORT}
      - GOTRUE_SMTP_USER=${GOTRUE_SMTP_USER}
      - GOTRUE_TRACING_ENABLED=${GOTRUE_TRACING_ENABLED}
      - GOTRUE_CLAIMER_NAMESPACE=${GOTRUE_CLAIMER_NAMESPACE}
      - GOTRUE_CLAIMER_RULES=${GOTRUE_CLAIMER_RULES}
    volumes:
      - ${PWD}/.data/gotrue:/go/src/github.com/netlify/gotrue/www
    depends_on:
      - database

  minio:
    image: "minio/minio"
    container_name: "minio"
    ports:
      - ${BARREL_MINIO_PORT}:9000
    command: server /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    environment:
      - MINIO_ACCESS_KEY=${BARREL_MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${BARREL_MINIO_SECRET_KEY}
      #- MINIO_ROOT_USER=${MINIO_ROOT_USER}
      #- MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - ${DATA_PATH}/minio:/data
